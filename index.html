<!DOCTYPE html>
<html>
<head>
  <title>Punching Data</title>
  <style>
    body { font-family: Arial; text-align: center; margin-top: 20px; }
    table { border-collapse: collapse; margin: auto; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; }
    th { background-color: #f4f4f4; }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">

  <div class="container py-5">

       <div class="card shadow-lg border-0 rounded-4">

          <div class="card-header bg-primary text-white text-center rounded-top-4">
            <h3 class="mb-0">Punching Data Software</h3>
          </div>

          <div class="card-body">
            <div class="row justify-content-center mb-4 text-center" id="empcode"></div>
           <div class="row justify-content-center mb-4">
            <div class="col-md-4">
              <input id="input2" 
                    type="date" 
                    class="form-control form-control-lg text-center"
                    value="">
            </div>

            <div class="col-md-2 d-grid">
              <button onclick="start()" 
                      class="btn btn-primary btn-lg">
                Search
              </button>
            </div>
          </div>

           <div class="text-center mb-4" id="status">
           
           </div>
           <div class="text-center mb-4">
              <span class="badge text-bg-danger">
                Next refresh in <span id="timer">60</span> sec
              </span>
           </div> 


            <div id="tableContainer" class="text-center"></div>

        </div>

      </div>
  
  </div>

  <script>
  /*   const fs = require("fs");
    const path = require("path");
    const { remote } = require("electron");
    const axios = require("axios"); */

   /*  const configPath = path.join(
        remote.app.getPath("userData"),
        "config.json"
    ); */

    let input1Value = "";

    window.addEventListener("DOMContentLoaded", async () => {
      const config = await window.api.getConfig();

      if (config && config.input1) {
          input1Value = config.input1;
      } else {
          alert("Setup not completed.");
      }

      const currentDate = new Date().toISOString().split("T")[0];
      document.getElementById("input2").value = currentDate;
   });
    
    
    
  let intervalId;
  let countdownInterval = null;
  let timeLeft = 60;

   onLoadstart(); 

   function start() {

      onLoadstart();

   }



    function renderTable(response) {

        let data = response.PunchData;

        document.getElementById("empcode").innerHTML = "<b>Employee Code : "+input1Value+"</b>";


        if (!Array.isArray(data) || data.length === 0) {
            document.getElementById("tableContainer").innerHTML = "No Data Found";
            document.getElementById("status").innerHTML = "";
            return;
        }

        const removeColumns = ["M_Flag"];

        // ðŸ”¥ Date parse function (DD/MM/YYYY format mate)
        function parseDate(dateStr) {
            const [datePart, timePart] = dateStr.split(" ");
            const [day, month, year] = datePart.split("/");
            return new Date(`${year}-${month}-${day}T${timePart}`);
        }

        // ðŸ”¥ PunchDate ascending sort
        data.sort((a, b) => parseDate(a.PunchDate) - parseDate(b.PunchDate));

        let table = "<table border='1' class='table table-bordered table-striped table-hover align-middle text-center shadow-sm'><tr>";

        Object.keys(data[0])
            .filter(key => !removeColumns.includes(key))
            .forEach(key => {
                table += `<th>${key}</th>`;
            });

        table += "<th>In/Out</th>";
        table += "</tr>";

        let lastInTime = null;
        let totalMilliseconds = 0;

        data.forEach((row, index) => {

            table += "<tr>";

            Object.entries(row)
                .filter(([key]) => !removeColumns.includes(key))
                .forEach(([key, value]) => {
                    table += `<td>${value ?? ""}</td>`;
                });

            let inOutLabel = "";

            // ðŸ”¥ Even index = Out (tamari logic pramane)
            if (index % 2 !== 0) {

                // Out
                inOutLabel = '<span style="color:red;font-weight:bold;">Out</span>';

                if (lastInTime) {
                    const outTime = parseDate(row.PunchDate);
                    totalMilliseconds += (outTime - lastInTime);
                    lastInTime = null;
                }
                
            } else {

              // In
                inOutLabel = '<span style="color:green;font-weight:bold;">In</span>';
                lastInTime = parseDate(row.PunchDate);
            }

            table += `<td>${inOutLabel}</td>`;
            table += "</tr>";
        });

        // ðŸ”¥ Total Time convert
        const totalMinutes = Math.floor(totalMilliseconds / 60000);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;

        const formattedTime =
            String(hours).padStart(2, "0") + ":" +
            String(minutes).padStart(2, "0");

        
        table += "</table>";

        document.getElementById("tableContainer").innerHTML = table;

        document.getElementById("status").innerHTML = '<span class="badge bg-success fs-5 px-4 py-2 shadow-sm"><span>Current Working Hours : '+formattedTime+'</span></span>'
    }

    function onLoadstart() {
      
      async function callAPI() {
        try {
          const val1 = input1Value;
          const val2 = document.getElementById("input2").value;
          
          const d = new Date(val2);
          const dateStr = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;  

          const response = await axios.get(
            "https://api.etimeoffice.com/api/DownloadPunchData",
            {
              params: {
                Empcode: val1,
                FromDate: `${dateStr}_00:01`,
                toDate: `${dateStr}_23:59`,
              },
              headers: {
                    Authorization: "Basic V2VibXluZTpXZWJteW5lOkNjQEAxMjM0NTp0cnVlOg=="
              },
              timeout: 10000
            }
          );
          renderTable(response.data);
          resetCountdown();

        } catch (err) {
          console.log("Error:", err.message);
        }
      }

      callAPI(); // first time immediately

      if (intervalId) clearInterval(intervalId);

      intervalId = setInterval(callAPI, 60000);

    }

    function resetCountdown() {

      timeLeft = 60;
      document.getElementById("timer").innerText = timeLeft;

      if (countdownInterval) clearInterval(countdownInterval);

      countdownInterval = setInterval(() => {

        timeLeft--;
        document.getElementById("timer").innerText = timeLeft;

        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
        }

      }, 1000);
    }

    /* function stop() {
      clearInterval(intervalId);
      document.getElementById("status").innerText = "Status: Stopped";
    } */
  </script>

</body>
</html>